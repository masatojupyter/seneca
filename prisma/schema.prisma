// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 管理者ユーザーモデル
model AdminUser {
  id            String    @id @default(cuid())
  email         String
  emailVerified DateTime?
  passwordHash  String
  name          String
  image         String?
  isActive      Boolean   @default(true)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // 承認/却下した申請はTimescaleDBで管理（approvedBy/rejectedByフィールド）

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, organizationId])
  @@index([organizationId])
}

// 従業員ユーザーモデル
model WorkerUser {
  id            String    @id @default(cuid())
  email         String
  emailVerified DateTime?
  passwordHash  String
  name          String
  image         String?

  // Worker固有フィールド
  hourlyRateUsd Decimal @db.Decimal(10, 2) // 時給(USD)
  isActive      Boolean @default(true)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  cryptoAddresses CryptoAddress[]
  // applications はTimescaleDBで管理（worker_idで紐付け）
  paymentRequests PaymentRequest[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([email, organizationId])
  @@index([organizationId])
}

// 暗号資産アドレス（複数登録可能）
model CryptoAddress {
  id           String     @id @default(cuid())
  workerId     String
  worker       WorkerUser @relation(fields: [workerId], references: [id], onDelete: Cascade)
  cryptoType   CryptoType @default(XRP)
  address      String
  label        String? // アドレスのラベル（例: "Main Wallet", "Hardware Wallet"）
  isDefault    Boolean    @default(false) // デフォルトアドレスかどうか
  isActive     Boolean    @default(true)
  hasTrustline Boolean    @default(false) // RLUSDトラストライン設定済みかどうか
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  history CryptoAddressHistory[]

  @@unique([workerId, address, cryptoType])
  @@index([workerId])
  @@index([isDefault])
}

// 暗号資産アドレス変更履歴
model CryptoAddressHistory {
  id              String        @id @default(cuid())
  cryptoAddressId String
  cryptoAddress   CryptoAddress @relation(fields: [cryptoAddressId], references: [id], onDelete: Cascade)
  action          AddressAction // 作成、更新、削除
  fieldName       String? // 変更されたフィールド名
  oldValue        String? // 変更前の値
  newValue        String? // 変更後の値
  changedAt       DateTime      @default(now())

  @@index([cryptoAddressId])
  @@index([changedAt])
}

enum AddressAction {
  CREATED
  UPDATED
  DELETED
  ACTIVATED
  DEACTIVATED
  SET_DEFAULT
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  adminUsers          AdminUser[]
  workerUsers         WorkerUser[]
  cryptoSetting       CryptoSetting?
  organizationWallets OrganizationWallet[]
  workerInvitations   WorkerInvitation[]
  adminInvitations    AdminInvitation[]
}

model CryptoSetting {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])

  // 自動支払い設定
  autoPaymentEnabled Boolean @default(false)
  maxAutoPaymentUsd  Decimal @db.Decimal(12, 2) // 最大自動支払い額(USD)
  dailyPaymentLimit  Int     @default(10)

  // 引き出し制限
  dailyAmountLimitUsd Decimal? @db.Decimal(12, 2) // 1日の合計引き出し上限(USD)
  newAddressLockHours Int      @default(0) // 新規アドレス登録後のロック時間
  require2FA          Boolean  @default(false) // 2FA必須かどうか

  // デフォルト支払い通貨
  defaultPaymentCrypto CryptoType @default(XRP)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 組織ウォレット（複数登録可能）
model OrganizationWallet {
  id                     String       @id @default(cuid())
  organizationId         String
  organization           Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  cryptoType             CryptoType   @default(XRP)
  walletAddress          String
  walletSecretEnc        String? // AES-256暗号化（GemWalletモードではnull）
  label                  String? // ラベル（例: "Main Wallet", "Payroll Wallet"）
  requiresManualSigning  Boolean      @default(false) // GemWallet等で手動署名が必要な場合true
  isDefault              Boolean      @default(false)
  isActive               Boolean      @default(true)
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt

  @@unique([organizationId, walletAddress, cryptoType])
  @@index([organizationId])
  @@index([isDefault])
}

// 対応暗号資産タイプ
enum CryptoType {
  XRP // XRP Ledger (ネイティブ通貨)
  RLUSD // RLUSD (Ripple USD ステーブルコイン)
}

// トークン発行者設定（RLUSD等のトークンの発行者アドレスを管理）
model TokenIssuerConfig {
  id            String     @id @default(cuid())
  cryptoType    CryptoType @unique // トークンタイプ（RLUSD等）
  issuerAddress String // 発行者のXRPLアドレス
  currencyCode  String // 通貨コード（"RLUSD" または16進数）
  network       String     @default("mainnet") // mainnet or testnet
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

// 従業員招待
model WorkerInvitation {
  id             String       @id @default(cuid())
  email          String
  token          String       @unique
  hourlyRateUsd  Decimal      @db.Decimal(10, 2) // 時給(USD)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())

  @@index([organizationId])
}

// 管理者招待
model AdminInvitation {
  id             String       @id @default(cuid())
  email          String
  token          String       @unique
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())

  @@index([organizationId])
}

// TimeApplicationはTimescaleDBで管理（time_applicationsテーブル）
// 申請データは時系列データとして大量に蓄積されるため、
// TimescaleDBのHypertableで効率的に管理する

model PaymentRequest {
  id             String     @id @default(cuid())
  workerId       String
  worker         WorkerUser @relation(fields: [workerId], references: [id])
  applicationIds String[]

  // 金額情報(USD基準)
  amountUsd    Decimal    @db.Decimal(12, 2) // 支払い額(USD)
  cryptoType   CryptoType @default(XRP) // 暗号資産タイプ
  cryptoRate   Decimal    @db.Decimal(18, 6) // 暗号資産/USDレート
  cryptoAmount Decimal    @db.Decimal(18, 6) // 暗号資産数量

  // 引き出し関連
  withdrawalType WithdrawalType @default(MANUAL)
  autoApproved   Boolean        @default(false)

  // ハッシュ関連（XRPLメモ用）
  dataHash          String? // SHA-256 ハッシュ
  canonicalDataJson String? @db.Text // 正規化データ（検証用）

  status          PaymentStatus @default(PENDING)
  transactionHash String?
  requestedAt     DateTime      @default(now())
  approvedAt      DateTime?
  approvedBy      String?
  processedAt     DateTime?
  createdAt       DateTime      @default(now())

  // applications はTimescaleDBで管理（applicationIdsで紐付け）

  @@index([workerId])
  @@index([status])
}

enum WithdrawalType {
  AUTO // 自動実行（設定内の金額）
  MANUAL // 手動実行（従業員リクエスト→管理者実行）
  ADMIN_APPROVED // 管理者承認後実行（高額時）
}

model NotificationSetting {
  id                String          @id @default(cuid())
  userId            String
  userType          UserType // ADMIN or WORKER
  emailEnabled      Boolean         @default(true)
  applicationNotify Boolean         @default(true)
  paymentNotify     Boolean         @default(true)
  digestFrequency   DigestFrequency @default(IMMEDIATE)

  @@unique([userId, userType])
}

enum UserType {
  ADMIN
  WORKER
}

enum ApplicationType {
  SINGLE // 単一申請
  BATCH // まとめ申請
  PERIOD // 期間一括申請
}

enum ApplicationStatus {
  PENDING // 承認待ち
  APPROVED // 承認済み
  REQUESTED // 支払いリクエスト作成済み
  PAID // 支払い完了
  REJECTED // 却下
}

enum RejectionCategory {
  TIME_ERROR // 時刻の誤り
  MISSING_REST // 休憩記録の漏れ
  DUPLICATE // 重複申請
  POLICY_VIOLATION // 規定違反
  OTHER // その他
}

enum PaymentStatus {
  PENDING // 支払い待ち
  PROCESSING // 処理中
  COMPLETED // 完了
  FAILED // 失敗
}

enum DigestFrequency {
  IMMEDIATE
  DAILY
}
